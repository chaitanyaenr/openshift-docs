:_mod-docs-content-type: ASSEMBLY
[id="recommended-node-practices"]
= Recommended node practices
include::_attributes/common-attributes.adoc[]
:context: recommended-node-practices

toc::[]

This topic provides recommended node practices for a Container Native Virtualization environment to be performant, scalable and resilient in {product-title}.

If a node fails and Node Health Checks operator is not deployed and configured with an appropriate remediation operator - Self Node Remediation (SNR) and/or Fence Agents Remediation (FAR) on your cluster, Virtual Machines (VMs) will encounter downtime until the node recovers as they are not automatically recovered to other available nodes by default.

Here are the configurations recommended to avoid VMs downtime on a critical environment and for your workloads to be resilient under node failure conditions:

-  Configure VMs with `runStrategy: Always` to allow the recovery to other available nodes.

include::modules/virt-configuring-runstrategy-vm.adoc[leveloffset=+2]


- Enable Node Health Checks to monitor the node status change from Ready to Unknown or NotReady, when a given node has not been able to contact the control plane for a defined period of time. spec.unhealthyConditions[].duration can be tuned to reduce the recovery timing. For example:

```
apiVersion: remediation.medik8s.io/v1alpha1
kind: NodeHealthCheck
metadata:
  name: nodehealthcheck-sample
spec:
  minHealthy: <set to 1 for critical environments> 
  pauseRequests: 
    - <pause-test-cluster>
  remediationTemplate: 
    apiVersion: self-node-remediation.medik8s.io/v1alpha1
    name: self-node-remediation-automatic-strategy-template
    namespace: openshift-workload-availability
    kind: SelfNodeRemediationTemplate
  escalatingRemediations: 
    - remediationTemplate:
        apiVersion: self-node-remediation.medik8s.io/v1alpha1
        name: self-node-remediation-resource-deletion-template
        namespace: openshift-workload-availability
        kind: SelfNodeRemediationTemplate
    order: 1
    timeout: 300s
  selector: 
    matchExpressions:
      - key: node-role.kubernetes.io/worker
        operator: Exists
  unhealthyConditions: 
    - type: Ready
      status: "False"
      duration: <set to lower timings for faster recovery, for example 20s> 
    - type: Ready
      status: Unknown
      duration: <set to lower timings for faster recovery, for example 20s>
```

Node Health Check operator supports several remediations. Self Node Remediation (SNR) or Fence Agents Remediation (FAR) remediation operators are few options  to apply after detecting a node failure.

- Self Node Remediation (SNR): Recommended for nodes that do not have a management interface, or the interface might be unreachable, since SNR does not require one to work.


- Fence Agents Remediation (FAR): Fastest remediation operator in terms of workload recovery time. It also requires a management interface. FAR is recommended when a management interface is available. Also, the management interface must be reachable from the Kubernetes pod network to work.

For more information on remediation, fencing, and maintaining nodes, see the link:https://access.redhat.com/documentation/en-us/workload_availability_for_red_hat_openshift/23.2/html-single/remediation_fencing_and_maintenance/index#about-remediation-fencing-maintenance[Workload Availability for Red Hat OpenShift] documentation.


- Capacity planning to ensure nodes have enough resources to host VMs migrated from the failed node(s). It is recommended to monitor the VMs count, resource available -  CPU, memory, disk, network on the cluster and ensure that there are enough resources on the nodes to host the VMs migrated from the failed nodes.


[IMPORTANT]
====
- The remediation actions starts after the node conditions monitored by NHC exceed the time specified in `spec.unhealthyConditions[].duration` and, can take large amounts of time depending on the number of VMS on the failed nodes. For example, 79 VMs with the following spec took 750 seconds to recover with SNR and will be much faster with FAR remediation strategy.

- FAR is recommended if the environment has access to baseboard management controller (BMC) interface because it is able to remediate and recover VMs quicker than SNR.
- Node running self-node-remediation-controller-manager pod getting disrupted will lead to longer recovery times.
====

[NOTE]
====
Number of VMs that a node can allocate depends on the maxPods set in the kubelet config:
```
 kubeletConfig:
    maxPods: <250 or 500>
```
====
